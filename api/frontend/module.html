<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Module</title>
</head>
<body>
<h1 id="loading">Getting Module Data...</h1>
<div>
	<div id="moduleHeader" style="line-height: 0;"></div>
	<div id="module" style="overflow-y:auto; max-height: 90%;">

	</div>
</div>
</body>
<script>
	let moduleData;
	async function getData() {
		const res = await fetch("/moduledata?id=" + new URLSearchParams(window.location.search).get("id"));
		moduleData = await res.json();
		document.getElementById("loading").innerText = "Done";
		document.getElementById("loading").style.display = "none";
		// console.log(moduleData);
	}

	async function init() {
		await getData();
		
		const module = document.getElementById("module");
		const moduleHeader = document.getElementById("moduleHeader");
		moduleHeader.innerHTML = `
			<h2 style="display:inline-block">${moduleData.course} by ${moduleData.teacher}</h2><br>
			<h4 style="display:inline-block">Created At: ${new Date(moduleData.createdAt).toLocaleString()}</h4><br>
			<h4 style="display:inline-block">Last Updated At: ${new Date(moduleData.updatedAt).toLocaleString()}</h4>
		`
		// const moduleContent = JSON.parse(moduleData.content);
		const moduleContent = moduleData.content;
		// console.log(moduleContent);
		const moduleContentDiv = document.getElementById("module");
		for (const category of moduleContent) {
			// console.log(category);
			const sectionTitle = document.createElement("h2");
			sectionTitle.innerText = category.name;
			moduleContentDiv.appendChild(sectionTitle);
			const sectionDiv = document.createElement("div");
			const formattedSectionName = category.name.replace(/\s+/g, '-').toLowerCase();
			sectionDiv.id = formattedSectionName;
			sectionDiv.style.position = "relative";
			sectionDiv.style.left = "20px";
			sectionDiv.style.width = "fit-content";
			moduleContentDiv.appendChild(sectionDiv);

			for (const item of category.items) {
				switch (item.type) {
					case "SubHeader":
						const subheaderDiv = document.createElement("div");
						subheaderDiv.innerHTML = `<h3>${item.title}</h3>`;
						document.getElementById(formattedSectionName).appendChild(subheaderDiv);
						break;
					case "File":
						const fileDiv = document.createElement("div");
						const fileLinkRes = await fetch("/modulefiles?page_id=" + item.id);
						const fileLinkData = await fileLinkRes.json();
						// console.log(item.id, fileLinkData);
						fileDiv.innerHTML = `<button style="margin-left: 20px;margin-bottom: 10px;" onclick="window.open('${fileLinkData[0].file}', '_blank')">Download ${item.title}</button>`;
						document.getElementById(formattedSectionName).appendChild(fileDiv);
						break;
					case "Page":
						const pageDiv = document.createElement("div");
						const pageDataRes = await fetch("/modulepage?module_id=" + item.id);
						const pageData = await pageDataRes.json();
						const pageFilesRes = await fetch("/modulefiles?page_id=" + item.id);
						const pageFilesData = await pageFilesRes.json();
						// console.log(item.id, pageData[0]);
						let pageContent =  pageData[0].content;
						const parser = new DOMParser();
						const ContentDoc = parser.parseFromString(pageContent, 'text/html');
						const aTags = ContentDoc.getElementsByTagName("a");
						let i = 0;
						for (const aTag of aTags) {
							if (pageFilesData[i]) {
								aTag.href = pageFilesData[i].file;
								aTag.target = "_blank";
							}
							i++;
						}
						pageContent = ContentDoc.documentElement.innerHTML;
						pageDiv.innerHTML = `<h3>${item.title}</h3><div>${pageContent}</div>`;
						pageDiv.style.border = "1px solid black";
						pageDiv.style.width = "fit-content";
						pageDiv.style.padding = "10px";
						pageDiv.style.marginLeft = "20px";
						pageDiv.style.marginBottom = "10px";
						document.getElementById(formattedSectionName).appendChild(pageDiv);
						break;
				}
			}
		}

	}
	
	init();
</script>
</html>